name: build-and-test

on:
    push:
        branches: [main]

jobs:
    test:
        name: run tests
        runs-on: ubuntu-latest
        services:
            postgres:
                image: postgres:13
                env:
                    POSTGRES_USER: gouser
                    POSTGRES_PASSWORD: password
                    POSTGRES_DB: gotransactions
                ports:
                - 5432:5432
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5
        steps:
            - name: fetch go
              uses: actions/setup-go@v2
              with:
                go-version: ^1.25
              id: go
            - name: Check out eh code
              uses: actions/checkout@v4

            - name: Install golang-migrate
              run: |
                curl -L https://github.com/golang-migrate/migrate/releases/download/v4.12.2/migrate.linux-amd64.tar.gz | tar xvz
                sudo mv migrate.linux-amd64 /usr/bin/migrate
                which migrate

            - name: Run migrations
              run: migrate -source file://migs -database postgres://gouser:password@localhost:5432/gotransactions?sslmode=disable up

            - name: running the tests
              run: go test ./...